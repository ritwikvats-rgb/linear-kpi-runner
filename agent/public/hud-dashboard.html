<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .header-nav {
      display: flex;
      gap: 12px;
    }

    .nav-link {
      padding: 8px 16px;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background: var(--primary);
      color: white;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #dcfce7;
      color: #166534;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      background: #f1f5f9;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Section Header */
    .section-header {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .cycle-badge {
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .section-subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 4px;
    }

    /* Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .card-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
    }

    .card-value.success { color: var(--success); }
    .card-value.warning { color: var(--warning); }
    .card-value.danger { color: var(--danger); }
    .card-value.primary { color: var(--primary); }

    .card-detail {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .chart-card.full-width {
      grid-column: span 2;
    }

    .chart-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .chart-container.small {
      height: 250px;
    }

    /* Tables */
    .table-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .data-table th {
      text-align: left;
      padding: 12px;
      background: #f8fafc;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .data-table tr:hover td {
      background: #f8fafc;
    }

    .status-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-pill.done { background: #dcfce7; color: #166534; }
    .status-pill.progress { background: #fef3c7; color: #92400e; }
    .status-pill.pending { background: #f1f5f9; color: #475569; }

    /* Insights */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .insight-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
    }

    .insight-card.highlight { border-left-color: var(--success); }
    .insight-card.warning { border-left-color: var(--warning); }
    .insight-card.action { border-left-color: var(--danger); }

    .insight-type {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .insight-title {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 4px;
    }

    .insight-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Footer */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      margin-top: 24px;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .cards-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .chart-card.full-width { grid-column: span 1; }
      .insights-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 640px) {
      .cards-grid { grid-template-columns: 1fr; }
      .insights-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .tabs { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>KPI Dashboard</h1>
      <nav class="header-nav">
        <a href="index.html" class="nav-link">Chat</a>
        <a href="charts.html" class="nav-link">Charts</a>
      </nav>
      <div class="status-badge">
        <span class="status-dot"></span>
        <span>Live</span>
        <span id="currentTime">--:--</span>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="del-kpi">DEL Metrics</button>
      <button class="tab-btn" data-tab="feature-kpi">Feature Execution</button>
      <button class="tab-btn" data-tab="pod-health">Pod Health</button>
    </nav>

    <!-- DEL Metrics Tab -->
    <div class="tab-content active" id="del-kpi">
      <div class="section-header">
        <h2 class="section-title">
          DEL Delivery Analysis
          <span class="cycle-badge" id="delCycleBadge">C2</span>
        </h2>
        <p class="section-subtitle">Tracking committed vs completed deliverables</p>
      </div>

      <div class="cards-grid" id="delCards">
        <div class="card">
          <div class="card-label">Delivery Rate</div>
          <div class="card-value primary" id="deliveryRate">--%</div>
          <div class="card-detail" id="deliveryDetail">Loading...</div>
        </div>
        <div class="card">
          <div class="card-label">Committed</div>
          <div class="card-value" id="committedCount">--</div>
          <div class="card-detail">Total DELs</div>
        </div>
        <div class="card">
          <div class="card-label">Completed</div>
          <div class="card-value success" id="completedCount">--</div>
          <div class="card-detail">Done</div>
        </div>
        <div class="card">
          <div class="card-label">Pending</div>
          <div class="card-value warning" id="pendingCount">--</div>
          <div class="card-detail">Remaining</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Delivery by Pod</div>
          <div class="chart-container">
            <canvas id="deliveryChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Cycle Trend</div>
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>

      <div class="table-card">
        <div class="chart-title">Pod Details</div>
        <table class="data-table" id="podTable">
          <thead>
            <tr>
              <th>Pod</th>
              <th>Committed</th>
              <th>Completed</th>
              <th>Pending</th>
              <th>Delivery %</th>
            </tr>
          </thead>
          <tbody id="podTableBody">
            <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Feature Execution Tab -->
    <div class="tab-content" id="feature-kpi">
      <div class="section-header">
        <h2 class="section-title">Feature Execution</h2>
        <p class="section-subtitle">Project progress across all pods</p>
      </div>

      <div class="cards-grid">
        <div class="card">
          <div class="card-label">Total Features</div>
          <div class="card-value" id="totalFeatures">--</div>
        </div>
        <div class="card">
          <div class="card-label">Done</div>
          <div class="card-value success" id="doneFeatures">--</div>
        </div>
        <div class="card">
          <div class="card-label">In Flight</div>
          <div class="card-value warning" id="inFlightFeatures">--</div>
        </div>
        <div class="card">
          <div class="card-label">Not Started</div>
          <div class="card-value" id="notStartedFeatures">--</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Feature Status</div>
          <div class="chart-container small">
            <canvas id="featureChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Feature + Tech Debt: Planned vs Completed</div>
          <div class="chart-container small">
            <canvas id="podFeatureChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Pod Health Tab -->
    <div class="tab-content" id="pod-health">
      <div class="section-header">
        <h2 class="section-title">Pod Health Overview</h2>
        <p class="section-subtitle">DEL completion status across teams</p>
      </div>

      <div class="charts-grid">
        <div class="chart-card full-width">
          <div class="chart-title">Completed vs Pending DELs by Pod</div>
          <div class="chart-container">
            <canvas id="podHealthChart"></canvas>
          </div>
        </div>
      </div>

      <div class="section-header" style="margin-top: 24px;">
        <h2 class="section-title">AI Insights</h2>
      </div>
      <div class="insights-grid" id="insightsGrid">
        <div class="insight-card">
          <div class="insight-type">Loading</div>
          <div class="insight-text">Analyzing data...</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <span>Last updated: <span id="lastUpdate">--</span></span>
      <span>KPI Dashboard v2.0</span>
    </footer>
  </div>

  <script>
    // Register Chart.js datalabels plugin
    Chart.register(ChartDataLabels);

    // Chart defaults
    Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
    Chart.defaults.plugins.datalabels.display = true;
    Chart.defaults.plugins.datalabels.color = '#1e293b';
    Chart.defaults.plugins.datalabels.font = { weight: 'bold', size: 11 };

    let chartInstances = {};

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Update time
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Cache keys for localStorage
    const CACHE_KEYS = {
      chartData: 'kpi_dashboard_chartData',
      insightsData: 'kpi_dashboard_insightsData',
      timestamp: 'kpi_dashboard_timestamp'
    };

    // Load cached data immediately (instant display)
    function loadFromCache() {
      try {
        const cachedChartData = localStorage.getItem(CACHE_KEYS.chartData);
        const cachedInsightsData = localStorage.getItem(CACHE_KEYS.insightsData);
        const cachedTimestamp = localStorage.getItem(CACHE_KEYS.timestamp);

        if (cachedChartData) {
          const chartData = JSON.parse(cachedChartData);
          if (chartData.success) {
            renderDelMetrics(chartData);
            renderFeatureMetrics(chartData);
            renderPodHealth(chartData);
          }
        }

        if (cachedInsightsData) {
          const insightsData = JSON.parse(cachedInsightsData);
          if (insightsData.success) {
            renderInsights(insightsData.insights);
          }
        }

        if (cachedTimestamp) {
          document.getElementById('lastUpdate').textContent = cachedTimestamp + ' (cached)';
        }

        return !!(cachedChartData || cachedInsightsData);
      } catch (e) {
        console.warn('Cache load failed:', e);
        return false;
      }
    }

    // Save data to cache
    function saveToCache(chartData, insightsData) {
      try {
        if (chartData) localStorage.setItem(CACHE_KEYS.chartData, JSON.stringify(chartData));
        if (insightsData) localStorage.setItem(CACHE_KEYS.insightsData, JSON.stringify(insightsData));
        localStorage.setItem(CACHE_KEYS.timestamp, new Date().toLocaleString('en-IN'));
      } catch (e) {
        console.warn('Cache save failed:', e);
      }
    }

    // Fetch fresh data and update
    async function loadDashboard(showLoadingIfNoCache = true) {
      // Show cached data instantly
      const hasCache = loadFromCache();

      // If no cache, show loading indicators
      if (!hasCache && showLoadingIfNoCache) {
        document.getElementById('deliveryRate').textContent = '--%';
        document.getElementById('deliveryDetail').textContent = 'Loading...';
      }

      // Fetch fresh data in background
      try {
        const [chartData, insightsData] = await Promise.all([
          fetch('/api/charts/data').then(r => r.json()),
          fetch('/api/charts/insights').then(r => r.json())
        ]);

        // Render fresh data
        if (chartData.success) {
          renderDelMetrics(chartData);
          renderFeatureMetrics(chartData);
          renderPodHealth(chartData);
        }

        if (insightsData.success) {
          renderInsights(insightsData.insights);
        }

        // Save to cache for next visit
        saveToCache(chartData, insightsData);

        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('en-IN');
      } catch (err) {
        console.error('Dashboard load error:', err);
        // Keep showing cached data if fetch fails
      }
    }

    function renderDelMetrics(data) {
      const { heroMetrics, deliveryChart, cycleTrendChart } = data;

      // Update cards
      document.getElementById('deliveryRate').textContent = heroMetrics.overallDeliveryPct + '%';
      document.getElementById('committedCount').textContent = heroMetrics.totalCommitted;
      document.getElementById('completedCount').textContent = heroMetrics.totalCompleted;
      document.getElementById('pendingCount').textContent = heroMetrics.totalCommitted - heroMetrics.totalCompleted;
      document.getElementById('deliveryDetail').textContent = `${heroMetrics.totalCompleted}/${heroMetrics.totalCommitted} DELs`;
      document.getElementById('delCycleBadge').textContent = heroMetrics.currentCycle;

      // Delivery chart - 3D-style bars with shadows
      if (chartInstances.delivery) chartInstances.delivery.destroy();
      const deliveryColors = deliveryChart.data.datasets[0].data.map(v =>
        v >= 70 ? '#10b981' : v >= 40 ? '#f59e0b' : '#ef4444'
      );
      const deliveryBorderColors = deliveryChart.data.datasets[0].data.map(v =>
        v >= 70 ? '#059669' : v >= 40 ? '#d97706' : '#dc2626'
      );
      chartInstances.delivery = new Chart(document.getElementById('deliveryChart'), {
        type: 'bar',
        data: {
          labels: deliveryChart.data.labels,
          datasets: [{
            label: 'Delivery %',
            data: deliveryChart.data.datasets[0].data,
            backgroundColor: deliveryColors,
            borderColor: deliveryBorderColors,
            borderWidth: { top: 0, right: 3, bottom: 3, left: 0 },
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: v => v + '%',
              font: { weight: 'bold', size: 12 },
              color: '#1e293b'
            }
          },
          scales: {
            y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
          }
        }
      });

      // Trend chart - with data labels
      if (cycleTrendChart && cycleTrendChart.data) {
        if (chartInstances.trend) chartInstances.trend.destroy();
        const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
        chartInstances.trend = new Chart(document.getElementById('trendChart'), {
          type: 'line',
          data: {
            labels: cycleTrendChart.data.labels,
            datasets: cycleTrendChart.data.datasets.map((ds, i) => ({
              ...ds,
              borderColor: colors[i % colors.length],
              backgroundColor: colors[i % colors.length] + '20',
              tension: 0.3,
              borderWidth: 3,
              pointRadius: 6,
              pointBackgroundColor: colors[i % colors.length],
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverRadius: 8
            }))
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              datalabels: {
                display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null && ctx.dataset.data[ctx.dataIndex] > 0,
                anchor: 'end',
                align: 'top',
                offset: 4,
                formatter: v => v !== null ? v + '%' : '',
                font: { weight: 'bold', size: 11 },
                color: '#1e293b',
                backgroundColor: 'rgba(255,255,255,0.8)',
                borderRadius: 4,
                padding: { top: 2, bottom: 2, left: 4, right: 4 }
              }
            },
            scales: {
              y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
            }
          }
        });
      }

      // Pod table
      const tbody = document.getElementById('podTableBody');
      tbody.innerHTML = deliveryChart.data.labels.map((pod, i) => {
        const pct = deliveryChart.data.datasets[0].data[i];
        const committed = deliveryChart.meta.committed[i];
        const completed = deliveryChart.meta.completed[i];
        const pending = committed - completed;
        const statusClass = pct >= 70 ? 'done' : pct >= 40 ? 'progress' : 'pending';
        return `<tr>
          <td><strong>${pod}</strong></td>
          <td>${committed}</td>
          <td>${completed}</td>
          <td>${pending}</td>
          <td><span class="status-pill ${statusClass}">${pct}%</span></td>
        </tr>`;
      }).join('');
    }

    function renderFeatureMetrics(data) {
      const { heroMetrics, featureChart } = data;

      document.getElementById('totalFeatures').textContent = heroMetrics.totalFeatures;
      document.getElementById('doneFeatures').textContent = heroMetrics.featuresDone;
      document.getElementById('inFlightFeatures').textContent = heroMetrics.featuresInFlight;
      document.getElementById('notStartedFeatures').textContent = heroMetrics.featuresNotStarted;

      // Feature pie chart
      if (featureChart && featureChart.data) {
        if (chartInstances.feature) chartInstances.feature.destroy();
        chartInstances.feature = new Chart(document.getElementById('featureChart'), {
          type: 'doughnut',
          data: {
            labels: featureChart.data.labels,
            datasets: [{
              data: featureChart.data.datasets[0].data,
              backgroundColor: ['#10b981', '#f59e0b', '#94a3b8'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              datalabels: {
                formatter: (v, ctx) => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  return total > 0 ? Math.round(v / total * 100) + '%' : '';
                },
                color: '#fff',
                font: { weight: 'bold', size: 14 }
              }
            }
          }
        });
      }

      // Pod features bar chart - Planned vs Completed comparison with 3D style
      if (chartInstances.podFeature) chartInstances.podFeature.destroy();

      // Use featureByPodChart data if available, otherwise fallback to deliveryChart
      if (data.featureByPodChart && data.featureByPodChart.data) {
        const fbp = data.featureByPodChart;
        chartInstances.podFeature = new Chart(document.getElementById('podFeatureChart'), {
          type: 'bar',
          data: {
            labels: fbp.data.labels,
            datasets: [
              {
                label: 'Planned',
                data: fbp.data.datasets[0].data,
                backgroundColor: '#6366f1',
                borderColor: '#4338ca',
                borderWidth: { top: 0, right: 3, bottom: 3, left: 0 },
                borderRadius: 6,
                borderSkipped: false
              },
              {
                label: 'Completed',
                data: fbp.data.datasets[1].data,
                backgroundColor: '#10b981',
                borderColor: '#059669',
                borderWidth: { top: 0, right: 3, bottom: 3, left: 0 },
                borderRadius: 6,
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: { usePointStyle: true, padding: 15 }
              },
              datalabels: {
                anchor: 'end',
                align: 'top',
                font: { weight: 'bold', size: 11 },
                color: '#1e293b',
                formatter: (value, ctx) => {
                  // Show completion rate for Completed bars
                  if (ctx.datasetIndex === 1 && fbp.meta && fbp.meta.completionRates) {
                    return value + ' (' + fbp.meta.completionRates[ctx.dataIndex] + '%)';
                  }
                  return value;
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Features' }
              }
            }
          }
        });
      } else if (data.deliveryChart) {
        // Fallback to old behavior
        chartInstances.podFeature = new Chart(document.getElementById('podFeatureChart'), {
          type: 'bar',
          data: {
            labels: data.deliveryChart.data.labels,
            datasets: [{
              label: 'Active Projects',
              data: data.deliveryChart.meta.committed,
              backgroundColor: '#4f46e5',
              borderColor: '#3730a3',
              borderWidth: { top: 0, right: 3, bottom: 3, left: 0 },
              borderRadius: 6,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'top',
                font: { weight: 'bold', size: 12 },
                color: '#1e293b'
              }
            }
          }
        });
      }
    }

    function renderPodHealth(data) {
      const { podHealthChart, deliveryChart } = data;
      if (!deliveryChart || !deliveryChart.data) return;

      if (chartInstances.health) chartInstances.health.destroy();

      // Create horizontal bar chart showing delivery % per pod
      const pods = deliveryChart.data.labels;
      const deliveryPct = deliveryChart.data.datasets[0].data;
      const committed = deliveryChart.meta.committed;
      const completed = deliveryChart.meta.completed;

      chartInstances.health = new Chart(document.getElementById('podHealthChart'), {
        type: 'bar',
        data: {
          labels: pods,
          datasets: [
            {
              label: 'Completed',
              data: completed,
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: { top: 0, right: 3, bottom: 3, left: 0 },
              borderRadius: 4,
              borderSkipped: false
            },
            {
              label: 'Pending',
              data: committed.map((c, i) => c - completed[i]),
              backgroundColor: '#f59e0b',
              borderColor: '#d97706',
              borderWidth: { top: 0, right: 3, bottom: 3, left: 0 },
              borderRadius: 4,
              borderSkipped: false
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            datalabels: {
              display: true,
              color: '#fff',
              font: { weight: 'bold', size: 11 }
            }
          },
          scales: {
            x: {
              stacked: true,
              title: { display: true, text: 'DELs' }
            },
            y: {
              stacked: true
            }
          }
        }
      });

      // Also render pod health table
      renderPodHealthTable(data);
    }

    function renderPodHealthTable(data) {
      const { deliveryChart, heroMetrics } = data;
      if (!deliveryChart) return;

      const tableHtml = `
        <table class="data-table" style="margin-top: 20px;">
          <thead>
            <tr>
              <th>Pod</th>
              <th>Delivery %</th>
              <th>Committed</th>
              <th>Completed</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${deliveryChart.data.labels.map((pod, i) => {
              const pct = deliveryChart.data.datasets[0].data[i];
              const committed = deliveryChart.meta.committed[i];
              const completed = deliveryChart.meta.completed[i];
              const status = pct >= 70 ? 'On Track' : pct >= 40 ? 'At Risk' : 'Behind';
              const statusClass = pct >= 70 ? 'done' : pct >= 40 ? 'progress' : 'pending';
              return `<tr>
                <td><strong>${pod}</strong></td>
                <td>${pct}%</td>
                <td>${committed}</td>
                <td>${completed}</td>
                <td><span class="status-pill ${statusClass}">${status}</span></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;

      // Insert table after chart
      const chartCard = document.querySelector('#pod-health .chart-card');
      if (chartCard) {
        const existingTable = chartCard.querySelector('.data-table');
        if (existingTable) existingTable.remove();
        chartCard.insertAdjacentHTML('beforeend', tableHtml);
      }
    }

    function renderInsights(insights) {
      const grid = document.getElementById('insightsGrid');
      if (!insights || insights.length === 0) {
        grid.innerHTML = '<div class="insight-card"><div class="insight-text">No insights available</div></div>';
        return;
      }

      grid.innerHTML = insights.slice(0, 6).map(insight => {
        const typeClass = insight.type === 'highlight' ? 'highlight' :
                         insight.type === 'warning' ? 'warning' :
                         insight.type === 'action' ? 'action' : '';
        return `<div class="insight-card ${typeClass}">
          <div class="insight-type">${insight.type}</div>
          <div class="insight-title">${insight.title}</div>
          <div class="insight-text">${insight.text}</div>
        </div>`;
      }).join('');
    }

    // Load dashboard on page load
    loadDashboard();

    // Refresh every 5 minutes
    setInterval(loadDashboard, 5 * 60 * 1000);
  </script>
</body>
</html>
