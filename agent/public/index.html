<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1a1a2e;
      color: white;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
    }

    header .status {
      font-size: 10px;
      color: #4ade80;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    header .status::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #4ade80;
      border-radius: 50%;
    }

    .charts-link {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      margin-left: auto;
      margin-right: 8px;
    }

    .charts-link:hover {
      opacity: 0.9;
    }

    .charts-link svg {
      opacity: 0.9;
      width: 16px;
      height: 16px;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 10px;
      line-height: 1.5;
      font-size: 13px;
    }

    .message.assistant {
      background: white;
      border: 1px solid #e8e8e8;
      align-self: flex-start;
    }

    .message.user {
      background: #1a1a2e;
      color: white;
      align-self: flex-end;
      font-size: 13px;
    }

    .message.loading {
      color: #888;
      font-style: italic;
      font-size: 12px;
    }

    /* Response Styling */
    .response-header {
      font-size: 13px;
      font-weight: 600;
      color: #1e293b;
      margin: 10px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
    }

    .response-header:first-child {
      margin-top: 0;
    }

    .response-subheader {
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      margin: 8px 0 4px 0;
    }

    /* Dynamic Table Styling */
    .data-table-wrap {
      margin: 8px 0;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      overflow-x: auto;
    }

    .table-title {
      background: #f1f5f9;
      color: #475569;
      padding: 6px 10px;
      font-weight: 600;
      font-size: 11px;
      border-bottom: 1px solid #e2e8f0;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .data-table th {
      background: #fafafa;
      color: #64748b;
      font-weight: 500;
      padding: 6px 10px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .data-table td {
      padding: 6px 10px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }

    .data-table tr:hover td {
      background: #f8fafc;
    }

    .data-table tr.total-row {
      background: #f1f5f9;
      font-weight: 600;
    }

    /* Status colors */
    .status-done { color: #059669; font-weight: 500; }
    .status-progress { color: #d97706; font-weight: 500; }
    .status-pending { color: #6b7280; }
    .status-todo { color: #3b82f6; }
    .status-review { color: #8b5cf6; }
    .status-backlog { color: #94a3b8; }

    .greeting {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 4px;
    }

    .greeting h2 {
      margin-bottom: 4px;
      font-size: 16px;
    }

    .greeting p {
      opacity: 0.9;
      font-size: 12px;
    }

    .quick-actions {
      padding: 8px 16px;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .quick-btn {
      padding: 5px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 14px;
      background: white;
      cursor: pointer;
      font-size: 11px;
      color: #555;
      transition: all 0.15s;
    }

    .quick-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .action-label {
      font-size: 10px;
      color: #888;
      font-weight: 500;
      margin-right: 2px;
    }

    .pod-actions {
      border-top: none;
      padding-top: 0;
    }

    .clear-btn {
      margin-left: auto;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      font-size: 10px;
      color: #999;
      transition: all 0.15s;
    }

    .clear-btn:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .quick-section {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .quick-divider {
      width: 1px;
      height: 16px;
      background: #e0e0e0;
      margin: 0 4px;
    }

    .input-area {
      padding: 10px 16px;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
    }

    #questionInput {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }

    #questionInput:focus {
      border-color: #1a1a2e;
    }

    #askBtn {
      padding: 10px 20px;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #askBtn:hover {
      background: #2d2d44;
    }

    #askBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      header {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 6px;
      }

      header h1 {
        font-size: 14px;
      }

      .charts-link {
        padding: 5px 8px;
        font-size: 10px;
        margin-left: 0;
        margin-right: 4px;
      }

      .chat-container {
        padding: 10px;
        gap: 8px;
      }

      .message {
        max-width: 90%;
        padding: 8px 10px;
        font-size: 12px;
      }

      .data-table {
        font-size: 11px;
      }

      .data-table th, .data-table td {
        padding: 5px 8px;
      }

      .quick-actions {
        padding: 6px 10px;
        gap: 4px;
      }

      .quick-btn {
        padding: 4px 8px;
        font-size: 10px;
      }

      .input-area {
        padding: 8px 10px;
      }

      .greeting {
        padding: 12px;
      }

      .greeting h2 {
        font-size: 14px;
      }

      .greeting p {
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .charts-link span {
        display: none;
      }

      .charts-link {
        padding: 6px;
      }

      .action-label {
        display: none;
      }

      .quick-divider {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>KPI Assistant</h1>
    <a href="hud-dashboard.html" class="charts-link" title="KPI Command Center" style="background: linear-gradient(135deg, #00f0ff, #ff00ff);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
      </svg>
      <span>Dashboard</span>
    </a>
    <a href="charts.html" class="charts-link" title="View Charts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <path d="M18 20V10"/>
        <path d="M12 20V4"/>
        <path d="M6 20v-6"/>
      </svg>
      <span>Charts</span>
    </a>
    <span class="status">Live Data</span>
  </header>

  <div class="chat-container" id="chat">
    <div class="greeting">
      <h2>Welcome!</h2>
      <p>Ask me about pod status, DEL metrics, or project updates. All answers come directly from your Linear data.</p>
    </div>
  </div>

  <div class="quick-actions">
    <div class="quick-section">
      <button class="quick-btn" data-question="What is going on across all pods?">All Pods</button>
      <button class="quick-btn" data-question="Show pending DELs">Pending</button>
    </div>
    <div class="quick-divider"></div>
    <div class="quick-section" id="cycle-actions"></div>
    <div class="quick-divider"></div>
    <div class="quick-section">
      <button class="quick-btn" data-question="What is the status of FTS?">FTS</button>
      <button class="quick-btn" data-question="What is the status of GTS?">GTS</button>
      <button class="quick-btn" data-question="What is the status of Control Center?">CC</button>
      <button class="quick-btn" data-question="What is the status of Talent Studio?">TS</button>
      <button class="quick-btn" data-question="What is the status of Platform?">Platform</button>
      <button class="quick-btn" data-question="What is the status of Growth and Reuse?">G&R</button>
      <button class="quick-btn" data-question="What is the status of ML?">ML</button>
      <button class="quick-btn" data-question="What is the status of FOT?">FOT</button>
      <button class="quick-btn" data-question="What is the status of BTS?">BTS</button>
      <button class="quick-btn" data-question="What is the status of DC?">DC</button>
    </div>
    <button class="clear-btn" onclick="clearChat()" title="Clear chat">Clear</button>
  </div>

  <div class="input-area">
    <input type="text" id="questionInput" placeholder="Ask a question... (e.g., What's the status of Platform?)" onkeypress="handleKeyPress(event)">
    <button id="askBtn" onclick="askQuestion()">Ask</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('questionInput');
    const btn = document.getElementById('askBtn');

    // Conversation history for follow-up questions
    let conversationHistory = [];

    function isMobile() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function addMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      if (type === 'assistant') {
        msg.innerHTML = renderResponse(text);
      } else {
        msg.textContent = text;
      }

      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
      return msg;
    }

    function renderResponse(text) {
      // Parse {{TABLE:...:TABLE}} markers
      if (text.indexOf('{{TABLE:') !== -1) {
        return parseAndRenderTables(text);
      }
      return formatPlainText(text);
    }

    function parseAndRenderTables(text) {
      let html = '';
      let pos = 0;

      while (pos < text.length) {
        const tableStart = text.indexOf('{{TABLE:', pos);

        if (tableStart === -1) {
          // No more tables, add remaining text
          html += formatPlainText(text.substring(pos));
          break;
        }

        // Add text before table
        if (tableStart > pos) {
          html += formatPlainText(text.substring(pos, tableStart));
        }

        // Find table end
        const tableEnd = text.indexOf(':TABLE}}', tableStart);
        if (tableEnd === -1) {
          html += formatPlainText(text.substring(pos));
          break;
        }

        // Extract and parse JSON
        const jsonStr = text.substring(tableStart + 8, tableEnd);
        try {
          const tableData = JSON.parse(jsonStr);
          html += renderTable(tableData);
        } catch (e) {
          console.error('Table parse error:', e, jsonStr.substring(0, 100));
          html += '<div class="data-table-wrap"><div class="table-title">Table Error</div></div>';
        }

        pos = tableEnd + 8;
      }

      return html;
    }

    function formatPlainText(text) {
      // Escape HTML
      let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      // Headers
      html = html.replace(/^## (.+)$/gm, '<h3 class="response-header">$1</h3>');
      html = html.replace(/^### (.+)$/gm, '<h4 class="response-subheader">$1</h4>');

      // Bold
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // Line breaks
      html = html.replace(/\n/g, '<br>');

      return html;
    }

    function renderTable(data) {
      const title = data.title || '';
      const columns = data.columns || [];
      const rows = data.rows || [];

      if (rows.length === 0) {
        return `<div class="data-table-wrap"><div class="table-title">${esc(title)}</div><p style="padding:12px;color:#666;">No data</p></div>`;
      }

      let html = '<div class="data-table-wrap">';
      if (title) {
        html += `<div class="table-title">${esc(title)}</div>`;
      }

      html += '<table class="data-table"><thead><tr>';
      for (const col of columns) {
        const header = typeof col === 'object' ? col.header : col;
        html += `<th>${esc(header)}</th>`;
      }
      html += '</tr></thead><tbody>';

      for (const row of rows) {
        html += '<tr>';
        for (const col of columns) {
          const key = typeof col === 'object' ? col.key : col;
          let value = row[key];
          if (value === undefined || value === null) value = '-';

          // Apply status styling
          const cellClass = getStatusClass(key, String(value));
          html += `<td class="${cellClass}">${esc(String(value))}</td>`;
        }
        html += '</tr>';
      }

      html += '</tbody></table></div>';
      return html;
    }

    function esc(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function getStatusClass(key, value) {
      const v = value.toLowerCase();
      if (key === 'status' || key === 'state') {
        if (v.includes('done') || v.includes('complete')) return 'status-done';
        if (v.includes('progress')) return 'status-progress';
        if (v.includes('review')) return 'status-review';
        if (v.includes('todo')) return 'status-todo';
        if (v.includes('backlog')) return 'status-backlog';
      }
      return '';
    }

    function ask(question) {
      input.value = question;
      askQuestion();
    }

    document.querySelectorAll('.quick-btn[data-question]').forEach(btn => {
      btn.addEventListener('click', () => ask(btn.dataset.question));
    });

    function handleKeyPress(e) {
      if (e.key === 'Enter') askQuestion();
    }

    async function askQuestion() {
      const question = input.value.trim();
      if (!question) return;

      addMessage(question, 'user');
      input.value = '';
      btn.disabled = true;

      const loadingMsg = addMessage('Fetching data from Linear...', 'assistant loading');

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question,
            mobile: isMobile(),
            history: conversationHistory  // Send conversation history for context
          })
        });

        const data = await res.json();
        loadingMsg.remove();

        if (data.success) {
          addMessage(data.answer, 'assistant');
          // Update conversation history
          conversationHistory.push({ role: 'user', content: question });
          conversationHistory.push({ role: 'assistant', content: data.answer });
          // Keep only last 6 messages (3 exchanges) to avoid token limits
          if (conversationHistory.length > 6) {
            conversationHistory = conversationHistory.slice(-6);
          }
        } else {
          addMessage(`Error: ${data.message || 'Something went wrong'}`, 'assistant');
        }
      } catch (err) {
        loadingMsg.remove();
        addMessage(`Error: Could not reach the server.`, 'assistant');
      }

      btn.disabled = false;
      input.focus();
    }

    input.focus();

    // Clear chat function
    function clearChat() {
      const greeting = document.querySelector('.greeting');
      chat.innerHTML = '';
      if (greeting) {
        chat.appendChild(greeting.cloneNode(true));
      } else {
        chat.innerHTML = `<div class="greeting"><h2>Welcome!</h2><p>Ask me about pod status, DEL metrics, or project updates.</p></div>`;
      }
      conversationHistory = [];
    }

    // Generate cycle buttons
    function getCurrentCycle() {
      const now = new Date();
      const month = now.getMonth();
      const day = now.getDate();
      if (month === 0) return day <= 15 ? 1 : 2;
      if (month === 1) return day <= 15 ? 3 : 4;
      if (month === 2) return day <= 15 ? 5 : 6;
      return 1;
    }

    function generateCycleButtons() {
      const container = document.getElementById('cycle-actions');
      const current = getCurrentCycle();
      for (let i = 1; i <= Math.min(current + 1, 6); i++) {
        const btn = document.createElement('button');
        btn.className = 'quick-btn';
        btn.dataset.question = `Show DELs in cycle C${i}`;
        btn.textContent = `C${i}`;
        if (i === current) {
          btn.style.background = '#1a1a2e';
          btn.style.color = 'white';
        }
        btn.addEventListener('click', () => ask(btn.dataset.question));
        container.appendChild(btn);
      }
    }

    generateCycleButtons();
  </script>
</body>
</html>
