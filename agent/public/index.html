<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1a1a2e;
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    header .status {
      font-size: 12px;
      color: #4ade80;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header .status::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
    }

    .charts-link {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      margin-left: auto;
      margin-right: 16px;
    }

    .charts-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .charts-link svg {
      opacity: 0.9;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 90%;
      padding: 16px 20px;
      border-radius: 12px;
      line-height: 1.6;
      font-size: 14px;
    }

    .message.assistant {
      background: white;
      border: 1px solid #e5e5e5;
      align-self: flex-start;
    }

    .message.user {
      background: #1a1a2e;
      color: white;
      align-self: flex-end;
    }

    .message.loading {
      color: #666;
      font-style: italic;
    }

    /* Response Styling */
    .response-header {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin: 16px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    .response-header:first-child {
      margin-top: 0;
    }

    .response-subheader {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
      margin: 14px 0 8px 0;
    }

    /* Dynamic Table Styling */
    .data-table-wrap {
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      overflow-x: auto;
    }

    .table-title {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 13px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      background: #f8fafc;
      color: #475569;
      font-weight: 600;
      padding: 10px 12px;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }

    .data-table tr:hover td {
      background: #f8fafc;
    }

    .data-table tr.total-row {
      background: #f1f5f9;
      font-weight: 600;
    }

    /* Status colors */
    .status-done { color: #059669; font-weight: 500; }
    .status-progress { color: #d97706; font-weight: 500; }
    .status-pending { color: #6b7280; }
    .status-todo { color: #3b82f6; }
    .status-review { color: #8b5cf6; }
    .status-backlog { color: #94a3b8; }

    .greeting {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .greeting h2 {
      margin-bottom: 8px;
    }

    .greeting p {
      opacity: 0.9;
      font-size: 14px;
    }

    .quick-actions {
      padding: 12px 24px;
      background: white;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .quick-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      background: #f0f0f0;
      border-color: #1a1a2e;
    }

    .action-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
      margin-right: 4px;
    }

    .pod-actions {
      border-top: none;
      padding-top: 0;
    }

    .input-area {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 12px;
    }

    #questionInput {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    #questionInput:focus {
      border-color: #1a1a2e;
    }

    #askBtn {
      padding: 14px 28px;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #askBtn:hover {
      background: #2d2d44;
    }

    #askBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 8px;
      }

      header h1 {
        font-size: 16px;
      }

      .charts-link {
        padding: 6px 10px;
        font-size: 11px;
        margin-left: 0;
        margin-right: 4px;
      }

      .chat-container {
        padding: 12px;
      }

      .message {
        max-width: 100%;
        padding: 12px;
        font-size: 13px;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th, .data-table td {
        padding: 8px 10px;
      }

      .quick-actions {
        padding: 8px 12px;
      }

      .quick-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .input-area {
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      .charts-link span {
        display: none;
      }

      .charts-link {
        padding: 8px;
      }

      .action-label {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>KPI Assistant</h1>
    <a href="hud-dashboard.html" class="charts-link" title="KPI Command Center" style="background: linear-gradient(135deg, #00f0ff, #ff00ff);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
      </svg>
      <span>Dashboard</span>
    </a>
    <a href="charts.html" class="charts-link" title="View Charts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path d="M18 20V10"/>
        <path d="M12 20V4"/>
        <path d="M6 20v-6"/>
      </svg>
      <span>Charts</span>
    </a>
    <span class="status">Live Data</span>
  </header>

  <div class="chat-container" id="chat">
    <div class="greeting">
      <h2>Welcome!</h2>
      <p>Ask me about pod status, DEL metrics, or project updates. All answers come directly from your Linear data.</p>
    </div>
  </div>

  <div class="quick-actions">
    <span class="action-label">Quick:</span>
    <button class="quick-btn" data-question="What is going on across all pods?">All Pods</button>
    <button class="quick-btn" data-question="Show pending DELs">Pending DELs</button>
  </div>

  <div class="quick-actions" id="cycle-actions" style="border-top: none; padding-top: 0;">
    <span class="action-label">Cycles:</span>
  </div>

  <div class="quick-actions pod-actions">
    <span class="action-label">Pods:</span>
    <button class="quick-btn" data-question="What is the status of FTS?">FTS</button>
    <button class="quick-btn" data-question="What is the status of GTS?">GTS</button>
    <button class="quick-btn" data-question="What is the status of Control Center?">Control Center</button>
    <button class="quick-btn" data-question="What is the status of Talent Studio?">Talent Studio</button>
    <button class="quick-btn" data-question="What is the status of Platform?">Platform</button>
    <button class="quick-btn" data-question="What is the status of Growth and Reuse?">Growth & Reuse</button>
  </div>

  <div class="input-area">
    <input type="text" id="questionInput" placeholder="Ask a question... (e.g., What's the status of Platform?)" onkeypress="handleKeyPress(event)">
    <button id="askBtn" onclick="askQuestion()">Ask</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('questionInput');
    const btn = document.getElementById('askBtn');

    function isMobile() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function addMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      if (type === 'assistant') {
        msg.innerHTML = renderResponse(text);
      } else {
        msg.textContent = text;
      }

      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
      return msg;
    }

    function renderResponse(text) {
      // Parse {{TABLE:...:TABLE}} markers
      if (text.indexOf('{{TABLE:') !== -1) {
        return parseAndRenderTables(text);
      }
      return formatPlainText(text);
    }

    function parseAndRenderTables(text) {
      let html = '';
      let pos = 0;

      while (pos < text.length) {
        const tableStart = text.indexOf('{{TABLE:', pos);

        if (tableStart === -1) {
          // No more tables, add remaining text
          html += formatPlainText(text.substring(pos));
          break;
        }

        // Add text before table
        if (tableStart > pos) {
          html += formatPlainText(text.substring(pos, tableStart));
        }

        // Find table end
        const tableEnd = text.indexOf(':TABLE}}', tableStart);
        if (tableEnd === -1) {
          html += formatPlainText(text.substring(pos));
          break;
        }

        // Extract and parse JSON
        const jsonStr = text.substring(tableStart + 8, tableEnd);
        try {
          const tableData = JSON.parse(jsonStr);
          html += renderTable(tableData);
        } catch (e) {
          console.error('Table parse error:', e, jsonStr.substring(0, 100));
          html += '<div class="data-table-wrap"><div class="table-title">Table Error</div></div>';
        }

        pos = tableEnd + 8;
      }

      return html;
    }

    function formatPlainText(text) {
      // Escape HTML
      let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      // Headers
      html = html.replace(/^## (.+)$/gm, '<h3 class="response-header">$1</h3>');
      html = html.replace(/^### (.+)$/gm, '<h4 class="response-subheader">$1</h4>');

      // Bold
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // Line breaks
      html = html.replace(/\n/g, '<br>');

      return html;
    }

    function renderTable(data) {
      const title = data.title || '';
      const columns = data.columns || [];
      const rows = data.rows || [];

      if (rows.length === 0) {
        return `<div class="data-table-wrap"><div class="table-title">${esc(title)}</div><p style="padding:12px;color:#666;">No data</p></div>`;
      }

      let html = '<div class="data-table-wrap">';
      if (title) {
        html += `<div class="table-title">${esc(title)}</div>`;
      }

      html += '<table class="data-table"><thead><tr>';
      for (const col of columns) {
        const header = typeof col === 'object' ? col.header : col;
        html += `<th>${esc(header)}</th>`;
      }
      html += '</tr></thead><tbody>';

      for (const row of rows) {
        html += '<tr>';
        for (const col of columns) {
          const key = typeof col === 'object' ? col.key : col;
          let value = row[key];
          if (value === undefined || value === null) value = '-';

          // Apply status styling
          const cellClass = getStatusClass(key, String(value));
          html += `<td class="${cellClass}">${esc(String(value))}</td>`;
        }
        html += '</tr>';
      }

      html += '</tbody></table></div>';
      return html;
    }

    function esc(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function getStatusClass(key, value) {
      const v = value.toLowerCase();
      if (key === 'status' || key === 'state') {
        if (v.includes('done') || v.includes('complete')) return 'status-done';
        if (v.includes('progress')) return 'status-progress';
        if (v.includes('review')) return 'status-review';
        if (v.includes('todo')) return 'status-todo';
        if (v.includes('backlog')) return 'status-backlog';
      }
      return '';
    }

    function ask(question) {
      input.value = question;
      askQuestion();
    }

    document.querySelectorAll('.quick-btn[data-question]').forEach(btn => {
      btn.addEventListener('click', () => ask(btn.dataset.question));
    });

    function handleKeyPress(e) {
      if (e.key === 'Enter') askQuestion();
    }

    async function askQuestion() {
      const question = input.value.trim();
      if (!question) return;

      addMessage(question, 'user');
      input.value = '';
      btn.disabled = true;

      const loadingMsg = addMessage('Fetching data from Linear...', 'assistant loading');

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, mobile: isMobile() })
        });

        const data = await res.json();
        loadingMsg.remove();

        if (data.success) {
          addMessage(data.answer, 'assistant');
        } else {
          addMessage(`Error: ${data.message || 'Something went wrong'}`, 'assistant');
        }
      } catch (err) {
        loadingMsg.remove();
        addMessage(`Error: Could not reach the server.`, 'assistant');
      }

      btn.disabled = false;
      input.focus();
    }

    input.focus();

    // Generate cycle buttons
    function getCurrentCycle() {
      const now = new Date();
      const month = now.getMonth();
      const day = now.getDate();
      if (month === 0) return day <= 15 ? 1 : 2;
      if (month === 1) return day <= 15 ? 3 : 4;
      if (month === 2) return day <= 15 ? 5 : 6;
      return 1;
    }

    function generateCycleButtons() {
      const container = document.getElementById('cycle-actions');
      const current = getCurrentCycle();
      for (let i = 1; i <= Math.min(current + 1, 6); i++) {
        const btn = document.createElement('button');
        btn.className = 'quick-btn';
        btn.dataset.question = `Show DELs in cycle C${i}`;
        btn.textContent = `C${i} DELs`;
        if (i === current) {
          btn.style.background = '#1a1a2e';
          btn.style.color = 'white';
        }
        btn.addEventListener('click', () => ask(btn.dataset.question));
        container.appendChild(btn);
      }
    }

    generateCycleButtons();
  </script>
</body>
</html>
