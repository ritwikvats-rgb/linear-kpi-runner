<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1a1a2e;
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    header .status {
      font-size: 12px;
      color: #4ade80;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header .status::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
    }

    .charts-link {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      margin-left: auto;
      margin-right: 16px;
    }

    .charts-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .charts-link svg {
      opacity: 0.9;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 85%;
      padding: 16px 20px;
      border-radius: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .message.assistant {
      background: white;
      border: 1px solid #e5e5e5;
      align-self: flex-start;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 13px;
    }

    .message.user {
      background: #1a1a2e;
      color: white;
      align-self: flex-end;
    }

    .message.loading {
      color: #666;
      font-style: italic;
    }

    .message h2, .message h3 {
      margin: 16px 0 8px 0;
      font-size: 14px;
    }

    .message h2:first-child, .message h3:first-child {
      margin-top: 0;
    }

    .quick-actions {
      padding: 12px 24px;
      background: white;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .quick-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      background: #f0f0f0;
      border-color: #1a1a2e;
    }

    .action-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
      margin-right: 4px;
    }

    .pod-actions {
      border-top: none;
      padding-top: 0;
    }

    .input-area {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 12px;
    }

    #questionInput {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    #questionInput:focus {
      border-color: #1a1a2e;
    }

    #askBtn {
      padding: 14px 28px;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #askBtn:hover {
      background: #2d2d44;
    }

    #askBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .greeting {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .greeting h2 {
      margin-bottom: 8px;
    }

    .greeting p {
      opacity: 0.9;
      font-size: 14px;
    }

    /* Dynamic Table Styling */
    .data-table-container {
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .table-title {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 13px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
    }

    .data-table th {
      background: #f8fafc;
      color: #475569;
      font-weight: 600;
      padding: 10px 12px;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }

    .data-table tr:hover td {
      background: #f8fafc;
    }

    .data-table tr.total-row {
      background: #f1f5f9;
      font-weight: 600;
    }

    .data-table tr.total-row td {
      border-top: 2px solid #cbd5e1;
    }

    /* Status colors */
    .status-done { color: #059669; font-weight: 500; }
    .status-progress { color: #d97706; font-weight: 500; }
    .status-pending { color: #6b7280; }

    /* Percentage colors */
    .pct-high { color: #059669; font-weight: 600; }
    .pct-med { color: #d97706; font-weight: 600; }
    .pct-low { color: #dc2626; font-weight: 600; }

    /* Response headers */
    .response-header {
      font-size: 15px;
      font-weight: 600;
      color: #1e293b;
      margin: 16px 0 8px 0;
      padding-bottom: 6px;
      border-bottom: 2px solid #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .response-subheader {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
      margin: 12px 0 6px 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .empty-table {
      color: #94a3b8;
      font-style: italic;
      padding: 12px;
    }

    /* Override monospace for assistant messages with tables */
    .message.assistant {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
    }

    /* ============== MOBILE RESPONSIVE ============== */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 8px;
      }

      header h1 {
        font-size: 16px;
      }

      .charts-link {
        padding: 6px 10px;
        font-size: 11px;
        margin-left: 0;
        margin-right: 4px;
      }

      .charts-link svg {
        width: 14px;
        height: 14px;
      }

      header .status {
        font-size: 10px;
        order: -1;
        width: 100%;
        justify-content: flex-end;
      }

      .chat-container {
        padding: 12px;
        gap: 12px;
      }

      .message {
        max-width: 100%;
        padding: 12px;
        font-size: 12px;
        overflow-x: auto;
      }

      .message.assistant {
        font-size: 11px;
        line-height: 1.4;
        /* Allow horizontal scroll for tables */
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Make ASCII tables scrollable */
      .message.assistant pre,
      .message.assistant code {
        white-space: pre;
        overflow-x: auto;
        display: block;
      }

      .greeting {
        padding: 16px;
      }

      .greeting h2 {
        font-size: 16px;
      }

      .greeting p {
        font-size: 12px;
      }

      .quick-actions {
        padding: 8px 12px;
        gap: 6px;
      }

      .action-label {
        font-size: 10px;
        width: 100%;
        margin-bottom: 4px;
      }

      .quick-btn {
        padding: 6px 10px;
        font-size: 11px;
        border-radius: 16px;
      }

      .input-area {
        padding: 12px;
        gap: 8px;
      }

      #questionInput {
        padding: 10px 12px;
        font-size: 14px;
      }

      #askBtn {
        padding: 10px 16px;
        font-size: 14px;
      }

      .message table {
        font-size: 10px;
        display: block;
        overflow-x: auto;
      }

      .message th, .message td {
        padding: 4px 6px;
        white-space: nowrap;
      }
    }

    /* Extra small screens */
    @media (max-width: 480px) {
      header h1 {
        font-size: 14px;
      }

      .charts-link span {
        display: none;
      }

      .charts-link {
        padding: 8px;
      }

      .message.assistant {
        font-size: 10px;
        letter-spacing: -0.3px;
      }

      .quick-btn {
        padding: 5px 8px;
        font-size: 10px;
      }

      .action-label {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>KPI Assistant</h1>
    <a href="hud-dashboard.html" class="charts-link" title="KPI Command Center" style="background: linear-gradient(135deg, #00f0ff, #ff00ff);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
      </svg>
      Dashboard
    </a>
    <a href="charts.html" class="charts-link" title="View Charts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path d="M18 20V10"/>
        <path d="M12 20V4"/>
        <path d="M6 20v-6"/>
      </svg>
      Charts
    </a>
    <span class="status">Live Data</span>
  </header>

  <div class="chat-container" id="chat">
    <div class="greeting">
      <h2>Welcome!</h2>
      <p>I'm your KPI assistant. Ask me about pod status, DEL metrics, or project updates. All answers come directly from your Linear data.</p>
    </div>
  </div>

  <div class="quick-actions">
    <span class="action-label">Quick:</span>
    <button class="quick-btn" data-question="What is going on across all pods?">All Pods</button>
    <button class="quick-btn" data-question="Show pending DELs">Pending DELs</button>
  </div>

  <div class="quick-actions" id="cycle-actions" style="border-top: none; padding-top: 0;">
    <span class="action-label">Cycles:</span>
    <!-- Cycle buttons will be dynamically generated -->
  </div>

  <div class="quick-actions pod-actions">
    <span class="action-label">Pods:</span>
    <button class="quick-btn" data-question="What is the status of FTS?">FTS</button>
    <button class="quick-btn" data-question="What is the status of GTS?">GTS</button>
    <button class="quick-btn" data-question="What is the status of Control Center?">Control Center</button>
    <button class="quick-btn" data-question="What is the status of Talent Studio?">Talent Studio</button>
    <button class="quick-btn" data-question="What is the status of Platform?">Platform</button>
    <button class="quick-btn" data-question="What is the status of Growth and Reuse?">Growth & Reuse</button>
  </div>

  <div class="input-area">
    <input type="text" id="questionInput" placeholder="Ask a question... (e.g., What's the status of Platform?)" onkeypress="handleKeyPress(event)">
    <button id="askBtn" onclick="askQuestion()">Ask</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('questionInput');
    const btn = document.getElementById('askBtn');

    // Detect if user is on mobile device
    function isMobile() {
      return window.innerWidth <= 768 ||
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function addMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      if (type === 'assistant') {
        // Parse and render structured content
        msg.innerHTML = renderResponse(text);
      } else {
        msg.textContent = text;
      }

      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
      return msg;
    }

    // Convert response text to HTML with proper tables
    function renderResponse(text) {
      // Check for JSON table markers
      if (text.includes('{{TABLE:')) {
        return renderWithTables(text);
      }

      // Escape HTML and convert basic formatting
      let html = escapeHtml(text);

      // Convert markdown-style headers
      html = html.replace(/^## (.+)$/gm, '<h3 class="response-header">$1</h3>');
      html = html.replace(/^### (.+)$/gm, '<h4 class="response-subheader">$1</h4>');

      // Convert bold
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // Convert line breaks
      html = html.replace(/\n/g, '<br>');

      return html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render response with embedded tables
    function renderWithTables(text) {
      let html = '';
      let remaining = text;

      while (remaining.includes('{{TABLE:')) {
        const start = remaining.indexOf('{{TABLE:');
        const end = remaining.indexOf(':TABLE}}');

        if (start === -1 || end === -1) break;

        // Add text before table
        const before = remaining.substring(0, start);
        html += escapeHtml(before).replace(/\n/g, '<br>');

        // Parse and render table
        const tableJson = remaining.substring(start + 8, end);
        try {
          const tableData = JSON.parse(tableJson);
          html += renderTable(tableData);
        } catch (e) {
          console.error('Table parse error:', e);
          html += '[Table Error]';
        }

        remaining = remaining.substring(end + 8);
      }

      // Add remaining text
      html += escapeHtml(remaining).replace(/\n/g, '<br>');

      return html;
    }

    // Render a data table as HTML
    function renderTable(data) {
      if (!data || !data.rows || data.rows.length === 0) {
        return '<p class="empty-table">No data</p>';
      }

      const title = data.title || '';
      const columns = data.columns || Object.keys(data.rows[0]);

      let html = '<div class="data-table-container">';
      if (title) {
        html += `<div class="table-title">${escapeHtml(title)}</div>`;
      }
      html += '<table class="data-table"><thead><tr>';

      for (const col of columns) {
        const header = col.header || col;
        html += `<th>${escapeHtml(header)}</th>`;
      }
      html += '</tr></thead><tbody>';

      for (const row of data.rows) {
        const isTotal = row._isTotal;
        html += `<tr class="${isTotal ? 'total-row' : ''}">`;
        for (const col of columns) {
          const key = col.key || col;
          const value = row[key] ?? '-';
          const className = getValueClass(key, value);
          html += `<td class="${className}">${escapeHtml(String(value))}</td>`;
        }
        html += '</tr>';
      }

      html += '</tbody></table></div>';
      return html;
    }

    // Get CSS class based on value
    function getValueClass(key, value) {
      if (key === 'status' || key === 'state') {
        const v = String(value).toLowerCase();
        if (v.includes('done') || v.includes('complete')) return 'status-done';
        if (v.includes('progress') || v.includes('flight')) return 'status-progress';
        if (v.includes('backlog') || v.includes('not started')) return 'status-pending';
      }
      if (key === 'deliveryPct' || key === 'delivery') {
        const num = parseInt(value);
        if (num >= 80) return 'pct-high';
        if (num >= 40) return 'pct-med';
        return 'pct-low';
      }
      return '';
    }

    function ask(question) {
      input.value = question;
      askQuestion();
    }

    // Handle quick action button clicks
    document.querySelectorAll('.quick-btn[data-question]').forEach(btn => {
      btn.addEventListener('click', () => {
        ask(btn.dataset.question);
      });
    });

    function handleKeyPress(e) {
      if (e.key === 'Enter') askQuestion();
    }

    async function askQuestion() {
      const question = input.value.trim();
      if (!question) return;

      // Add user message
      addMessage(question, 'user');
      input.value = '';
      btn.disabled = true;

      // Add loading message
      const loadingMsg = addMessage('Fetching data from Linear...', 'assistant loading');

      try {
        // Pass mobile flag for simplified output on small screens
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, mobile: isMobile() })
        });

        const data = await res.json();

        // Remove loading message
        loadingMsg.remove();

        if (data.success) {
          addMessage(data.answer, 'assistant');
        } else {
          addMessage(`Error: ${data.message || 'Something went wrong'}`, 'assistant');
        }
      } catch (err) {
        loadingMsg.remove();
        addMessage(`Error: Could not reach the server. Is it running?`, 'assistant');
      }

      btn.disabled = false;
      input.focus();
    }

    // Focus input on load
    input.focus();

    // Dynamic cycle buttons based on current date
    function getCurrentCycle() {
      const now = new Date();
      const month = now.getMonth(); // 0-indexed (0=Jan, 1=Feb, 2=Mar)
      const day = now.getDate();

      // Q1 2026 cycles (Jan-Mar)
      // C1: Jan 1-15, C2: Jan 16-31
      // C3: Feb 1-15, C4: Feb 16-28/29
      // C5: Mar 1-15, C6: Mar 16-31

      if (month === 0) { // January
        return day <= 15 ? 1 : 2;
      } else if (month === 1) { // February
        return day <= 15 ? 3 : 4;
      } else if (month === 2) { // March
        return day <= 15 ? 5 : 6;
      }
      // Default to C1 if outside Q1
      return 1;
    }

    function generateCycleButtons() {
      const cycleContainer = document.getElementById('cycle-actions');
      const currentCycle = getCurrentCycle();

      // Show current cycle and all previous cycles (completed ones)
      // Plus next cycle if not at C6
      let cyclesToShow = [];

      // Add all cycles from C1 to current+1 (or C6 max)
      for (let i = 1; i <= Math.min(currentCycle + 1, 6); i++) {
        cyclesToShow.push(i);
      }

      // Generate buttons
      cyclesToShow.forEach(cycle => {
        const btn = document.createElement('button');
        btn.className = 'quick-btn';
        btn.dataset.question = `Show DELs in cycle C${cycle}`;
        btn.textContent = `C${cycle} DELs`;

        // Highlight current cycle
        if (cycle === currentCycle) {
          btn.style.background = '#1a1a2e';
          btn.style.color = 'white';
          btn.style.borderColor = '#1a1a2e';
        }

        btn.addEventListener('click', () => {
          ask(btn.dataset.question);
        });

        cycleContainer.appendChild(btn);
      });
    }

    // Generate cycle buttons on page load
    generateCycleButtons();
  </script>
</body>
</html>
